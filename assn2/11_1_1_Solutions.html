<!DOCTYPE html>
<html lang="en" class="tas-com">

<head>
  <meta charset="utf-8">
  <title>D3: Updating Data Joins</title>
  <link href="./themes/prism.css" rel="stylesheet" />
  <link href="./themes/tas_style.css" rel="stylesheet" />
  <script type="text/javascript" src="./d3/d3.v4.js" charset="utf-8"></script>
  <script src="./lib/prism.js" charset="utf-8"></script>
  <style type="text/css">
  .axis path,
  .axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
  }
  .axis text {
    font-family: sans-serif;
    font-size: 11px;
}
.rangeslider{
    width: 50%;
    }
    .myslider {
    -webkit-appearance: none;
    background: #FCF3CF  ;
    width: 50%;
    height: 20px;
    opacity: 2;
   }
</style>
</head>
<div class="rangeslider">
  <!-- <input type="range" min="2007" max="2016" value="2016"
                  class="myslider" id="sliderRange"> -->

  <button id="button" onclick="complement()">press here to get your mind blown</button>
  <p>Value: <span id="demo"></span></p>
</div>
<body>
  <script type="text/javascript">
  var btnClicked = true;
  // Define margins
  function complement()
  {
    btnClicked=!btnClicked;
  }
  var margin = {
    top: 10,
    right: 10,
    bottom: 25,
    left: 70
  };
  // Load the file data.csv and generate a visualisation based on it
  d3.csv("./rapidmined2.csv", function(error, data) {
    var s,cnames=['Pick a country']
    // handle any data loading errors
    if (error) {
      console.log("Something went wrong");
      console.log(error);
    } else {
      console.log("Data Loaded");
      svg.append("text")
      .attr("id","bgyear")
      .attr("x",svg_width/2)
      .attr("y",svg_height/2+300)
      .attr("opacity",0.2)
      .attr("font-size",200).text(display_year);
      // Assign  the data object loaded to the global dataset variable
      dataset = data;
      svg.select("#x-axis").call(xAxis);
      var filtered_dataset3 = dataset.filter(yearFilter);
      dataset.forEach(function(d) {
        d.GDP = +d.GDP;
        d.Global_Competitiveness_Index = +d.Global_Competitiveness_Index;
        d.Population=+d.Population;

      });
      var select = d3.select("div")
   .append("select")

 select
   .on("change", function(d) {
     var value = d3.select(this).property("value");
   });

 select.selectAll("option")
   .data(filtered_dataset3)
   .enter()
     .append("option")
     .attr("value", function (d) { return d.Country; })
     .text(function (d) { return d.Country; });

      //xScale.domain([0,d3.max(dataset,function(d){return Math.log(d.GDP,10);})])
      xScale.domain([0,1.4*d3.max(dataset,function(d){return d.GDP;})])
      yScale.domain([0,1.1*d3.max(dataset,function(d){return d.Global_Competitiveness_Index;})])
      rScale.domain([0,d3.max(dataset,function(d){return d.Population;})])
      tScale.domain([0,d3.max(dataset,function(d){return d.Population;})])


      console.log("hey?");
      // Call the x-axis
      svg.select("#x-axis").call(xAxis);
      svg.select("#y-axis").call(yAxis);
      //Generate the visualisation
      generateVis();
      var timeoutID;
      document.getElementById('button').addEventListener('click', function() {

  if (btnClicked) {
    console.log('Stopped');
    clearInterval(timeoutID);
    timeoutID = null;
  } else {
 timeoutID = setInterval(function() {
        //if(!btnClicked)clearInterval(intervfn);
        display_year = display_year + 1;
        if (display_year > 2017) {
          display_year = 2007;
        }
        // var rangeslider = document.getElementById("sliderRange");
        var output = document.getElementById("demo");


        d3.select("#bgyear").text(display_year)
        output.innerHTML = display_year;
        // rangeslider.value=display_year;
        console.log("hey");


            generateVis();
      },1500)}}
    );


}
});


  function mouseOver() {
      document.getElementById("circle").style.color = "Black";
  }

  function mouseOut() {
      document.getElementById("circle").style.color = "red";
  }


  //Width and height
  var outer_width = 1000;
  var outer_height = 700;
  var svg_width = outer_width - margin.left - margin.right;
  var svg_height = outer_height - margin.top - margin.bottom;

  // The year to display
  display_year = 2007;

  // define a function that filters data by year
  function yearFilter(value) {
    return (value.Year == display_year)
  }

  function startTimer () {
    timer.start();
    setTimeout(stopTimer,2000);
}
function stopTimer () {
    timer.stop;
}
  //Create SVG element as a group with the margins transform applied to it
  var svg = d3.select("body")
  .append("svg")
  .attr("width", svg_width + margin.left + margin.right)
  .attr("height", svg_height + margin.top + margin.bottom)
  .attr("background","AliceBlue")
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Create a scale to scale market share values nicely for bar heights
  var yScale = d3.scalePow().exponent(2)
  .range([svg_height,0]);
  var tScale=d3.scalePow().exponent(0.25).range([0,20]);

  // Create a scale object to nicely take care of positioning country along the horizontal axis
  // We don't set the domain yet as data isn't loaded
   var xScale = d3.scalePow().exponent(0.25).range([0, svg_width]);
  // var xScale = d3.scaleLog().base(Math.E).range([0, svg_width]);

  //xScale.domain(dataset.map(function(d) { return d.GDP; }));//Define Y axis
  var yAxis = d3.axisLeft()
  .scale(yScale)
  .ticks(5);

  // Create an x-axis connected to the x scale
  var xAxis = d3.axisBottom()
  .scale(xScale).ticks(5);

  var rScale = d3.scaleSqrt()
  .range([0, 35]);

  // Call the y axis
  svg.append("g")
  .attr("class", "axis")
  .attr("id", "y-axis");

  // All but call the x-axis
  svg.append("g")
  .attr("class", "axis")
  .attr("id", "x-axis")
  .attr("transform", "translate(0," + svg_height + ")");


  // Define a fucntion to draw a simple bar chart
  function generateVis() {
    // Filter the data to only include the current year


    /******** PERFORM DATA JOIN ************/
    // Join new data with old elements, if any.
    var filtered_dataset = dataset.filter(yearFilter);
    var country = svg.selectAll("circle")
    .data(filtered_dataset);
    var countrytxt = svg.selectAll("#yesboi")
    .data(filtered_dataset);


    /******** HANDLE ENTER SELECTION ************/
    // Create new elements in the dataset

    country.enter()
    .append("circle")
    .attr("cx", function(d) {
      //return xScale(Math.log(d.GDP,power));
      return xScale(d.GDP);
    })
    .attr("cy", function(d) {
      return yScale(d.Global_Competitiveness_Index);
    })
    .attr("r", function(d) {
      return rScale(d.Population);
    })
    .attr("stroke","black")
    .attr("stroke-width",1)
    .attr("fill",function(d){
        if(d.Forum_classification=="Europe and North America")
        {
        return "LightBlue";
        }
        if(d.Forum_classification=="Eurasia")
        {return "Crimson";}
        if(d.Forum_classification=="Sub-Saharan Africa")
        {return "rgb(0, 30, 160)"}
        if(d.Forum_classification=="Latin America and the Caribbean")
        {
          return "rgb(145, 30, 180)"}
        if(d.Forum_classification=="East Asia and Pacific")
        {return "LightGreen";}
        if(d.Forum_classification=="South Asia")
        {
          return "rgb(210, 245, 60)";}
      if(d.Forum_classification=="Middle East and North Africa")
          {return "Gold";}
            console.log(d.Forum_classification);})
            .attr("opacity",.8);


    /******** HANDLE UPDATE SELECTION ************/
    // Update the display of existing elelemnts to mathc new data
    // filtered_dataset.forEach(function(d) {
    //   d3.select("svg").select("#d.Country")
    countrytxt.enter().append("text").attr("id","yesboi").attr("x",function(d){ return xScale(d.GDP)})
    .attr("y",function(d) {return yScale(d.Global_Competitiveness_Index)})
    .text(function(d){return d.Country;})
    .attr("font-size", function (d)  { return tScale(d.Population)-1})

      countrytxt.attr("x",function(d){ return xScale(d.GDP)})
      .attr("y",function(d) {return yScale(d.Global_Competitiveness_Index)})
          .text(function(d){return d.Country;})
          .attr("font-size", function (d)  { return tScale(d.Population)})
    //  console.log(d.Year)
  //  });
  countrytxt.exit().remove()


    country.transition()
    .duration(500)
    .ease(d3.easeLinear).attr("cx", function(d) {
    //  return xScale(Math.log(d.GDP,power));
    return xScale(d.GDP);
    })
    .attr("cy", function(d) {
      return yScale(+d.Global_Competitiveness_Index);
    })
    .attr("r", function(d) {
      return rScale(d.Population);
    })
    .attr("fill",function(d){

        if(d.Forum_classification=="Europe and North America")
        {
        return "LightBlue";
        }
        if(d.Forum_classification=="Eurasia")
        {return "Crimson";}
        if(d.Forum_classification=="Sub-Saharan Africa")
        {return "rgb(0, 30, 160)"}
        if(d.Forum_classification=="Latin America and the Caribbean")
        {
          return "rgb(145, 30, 180)"}
        if(d.Forum_classification=="East Asia and Pacific")
        {return "LightGreen";}
        if(d.Forum_classification=="South Asia")
        {
          return "rgb(210, 245, 60)";}
      if(d.Forum_classification=="Middle East and North Africa")
          {return "Gold";}
            console.log(d.Forum_classification);}).attr("opacity",.8);




      /******** HANDLE EXIT SELECTION ************/
      // Remove country that not longer have a matching data eleement
      country.exit().remove();

      // Set the year label
      d3.select("#year_header").text("Year: " + display_year)

    }
var power =123;

    </script>
  </div>
</body>

</html>
